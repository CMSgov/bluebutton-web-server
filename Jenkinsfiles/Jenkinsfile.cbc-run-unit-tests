void notifyGithubStatus(String state, String mesg) {
    echo "Notifying status on GitHub to: " + state + " with message: " + mesg
    step([
        $class: "GitHubCommitStatusSetter",
        contextSource: [$class: "ManuallyEnteredCommitContextSource", context: "ci/jenkins/check-unit-tests"],
        statusResultSource: [ $class: "ConditionalStatusResultSource", results: [[$class: "AnyBuildResult", message: mesg, state: state]] ]
  ]);
}

pipeline {
  agent {
    kubernetes {
      defaultContainer "bb2-cbc-build"
      yamlFile "Jenkinsfiles/cbc-pod-deployment-config.yml"
    }
  }

  stages {
    stage("Create venv and install dependencies") {
      steps {
        notifyGithubStatus("PENDING", "Unit tests are running...");
        sh """
          python -m venv venv
          . venv/bin/activate
          # Install from vendor files in requirements.txt
          make reqs-install
          # Install additional packages in requirements.dev.txt
          make reqs-install-dev
        """
      }
    }

    stage("Run Django unit tests") {
      steps{
        sh """
        . venv/bin/activate
        python runtests.py
        """
      }
    }
  }

  post {
    success {
      githubNotify(context: 'ci/jenkins/check-unit-tests', description: 'Unit tests SUCCESS!',  status: 'SUCCESS');
      notifyGithubStatus("SUCCESS", "Unit testing SUCCESS!");
    }
    failure {
      notifyGithubStatus("FAILED", "Unit testing FAILED!");
      githubNotify(context: 'ci/jenkins/check-unit-tests', description: 'Unit tests FAILED!',  status: 'FAILED');
    }
  }
}
