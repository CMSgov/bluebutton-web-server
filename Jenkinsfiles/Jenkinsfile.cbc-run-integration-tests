pipeline {
  agent {
    kubernetes {
      defaultContainer "bb2-cbc-build"
      yamlFile "Jenkinsfiles/cbc-run-integration-tests.yaml"
    }
  }

  environment {
    DJANGO_USER_ID_SALT = credentials("bb2-integration-tests-bfd-salt")
    DJANGO_USER_ID_ITERATIONS = credentials("bb2-integration-tests-bfd-iterations")
    BRANCH = "${params.COMMIT_SHA == "" ? params.BRANCH : params.COMMIT_SHA}"
    FHIR_URL = "${params.FHIR_URL}"
    DJANGO_FHIR_CERTSTORE = "./certstore/"
  }

  parameters {
    string(
      name: "BRANCH",
      defaultValue: "master",
      description: "The branch of the bluebutton-web-server repo to test."
    )
    string(
      name: 'COMMIT_SHA',
      defaultValue: "",
      description: 'The commit sha to send status updates for. If specified, this variable overrides BRANCH.'
    )
    string(
      name: 'FHIR_URL',
      defaultValue: "https://prod-sbx.bfdcloud.net/v1/fhir/",
      description: 'The default FHIR URL for the back end BFD service.'
    )
  }

  stages {

   stage("Checkout BRANCH or COMMIT_SHA") {
      steps {
        git branch: 'env.BRANCH', url: "https://github.com/CMSgov/bluebutton-web-server.git"
      }
    }

    stage("Run integration tests") {
      steps {
        withCredentials([
          file(credentialsId: "bb2-integration-tests-bfd-cert", variable: 'cf'),
          file(credentialsId: "bb2-integration-tests-bfd-key", variable: 'kf')
        ]) {
          writeFile file: "${env.DJANGO_FHIR_CERTSTORE}/certstore/ca.cert.pem", text: readFile(cf)
          writeFile file: "${env.DJANGO_FHIR_CERTSTORE}/certstore/ca.key.nocrypt.pem", text: readFile(kf)
          script {
            echo("Running integration tests...")
            sh """
              pwd
              ls -ld ${DJANGO_FHIR_CERTSTORE}/*
              ./docker-compose/run_integration_tests_docker_cbc_build.sh
            """
            }
          }
        }
      }
    }
  }

  post {
    success {
      script {
        echo "SUCCESS"
      }
    }

    failure {
      script {
        echo "FAILURE"
      }
    }
  }
}
