version: '3'

services:
  db:
    image: postgres
    environment:
            - POSTGRES_DB=bluebutton
            - POSTGRES_PASSWORD=toor
    ports:
            - "5432:5432"
  web:
    build: . 
    command: ./docker-compose/bluebutton_server_start.sh '${DB_MIGRATIONS}' '${SUPER_USER_NAME}' '${SUPER_USER_EMAIL}' '${SUPER_USER_PASSWORD}' '${BB20_ENABLE_REMOTE_DEBUG}' '${BB20_REMOTE_DEBUG_WAIT_ATTACH}'
    environment:
            - DJANGO_SETTINGS_MODULE=hhs_oauth_server.settings.dev
            - DATABASES_CUSTOM=postgres://postgres:toor@db:5432/bluebutton
            - OAUTHLIB_INSECURE_TRANSPORT=true
            - DJANGO_SECURE_SESSION=False
            - DJANGO_LOG_JSON_FORMAT_PRETTY=True
            # SLSx settings:
            - DJANGO_MEDICARE_SLSX_AKAMAI_ACA_TOKEN=${DJANGO_MEDICARE_SLSX_AKAMAI_ACA_TOKEN}
            - DJANGO_MEDICARE_SLSX_REDIRECT_URI=http://localhost:8000/mymedicare/sls-callback
            - DJANGO_MEDICARE_SLSX_LOGIN_URI=https://test.medicare.gov/sso/authorize?client_id=bb2api
            - DJANGO_SLSX_HEALTH_CHECK_ENDPOINT=https://test.accounts.cms.gov/health
            - DJANGO_SLSX_TOKEN_ENDPOINT=https://test.medicare.gov/sso/session
            - DJANGO_SLSX_SIGNOUT_ENDPOINT=https://test.medicare.gov/sso/signout
            - DJANGO_SLSX_USERINFO_ENDPOINT=https://test.accounts.cms.gov/v1/users
            #   SLSx credentials
            - DJANGO_SLSX_CLIENT_ID=bb2api
            - DJANGO_SLSX_CLIENT_SECRET=${DJANGO_SLSX_CLIENT_SECRET}
            #     SSL verify for internal endpoints can't currently use SSL verification (this may change in the future)
            - DJANGO_SLSX_VERIFY_SSL_INTERNAL=False
            - DJANGO_SLSX_VERIFY_SSL_EXTERNAL=True
            # End SLSx
            # AWS credentials
            - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
            - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
            - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
            - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
            # AWS firehose
            - DJANGO_LOG_FIREHOSE_STREAM_NAME="bfd-insights-bb2-events"
            # BFD credentials/settings
            - DJANGO_USER_ID_SALT=${DJANGO_USER_ID_SALT}
            - DJANGO_USER_ID_ITERATIONS=${DJANGO_USER_ID_ITERATIONS}
            - FHIR_URL="https://prod-sbx.bfd.cms.gov"
            - DJANGO_FHIR_CERTSTORE=/code/docker-compose/certstore/
            - DJANGO_DEFAULT_SAMPLE_FHIR_ID="-20140000008325"
            # AWS EC2 instance metadata (False for local dev)
            - DJANGO_GET_EC2_METADATA=False
    volumes:
      - .:/code
    ports:
      - "8000:8000"
      - "5678:5678"
    depends_on:
      - db
  unittests:
    build: .
    command: python3 -m debugpy --listen 0.0.0.0:6789 --wait-for-client runtests.py
    environment:
            - DJANGO_SETTINGS_MODULE=hhs_oauth_server.settings.dev
            - DATABASES_CUSTOM=postgres://postgres:toor@db:5432/bluebutton
            - OAUTHLIB_INSECURE_TRANSPORT=true
            - DJANGO_DEFAULT_SAMPLE_FHIR_ID="-20140000008325"
            - DJANGO_SECURE_SESSION=False
    ports:
      - "6789:6789"
    volumes:
      - .:/code
    
