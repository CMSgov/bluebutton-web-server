<form>
    <label>BB2 Synthetic Data Engagement Dashboard</label>
    <description>Synthetic Data Access Stats on Legacy (-19990000000001~-19990000010000, -20000000000001~-20000000010000, -20140000000001~-20140000010000) vs. New (-1000000000000~-10000000009999) Beneficiaries.</description>
    <fieldset submitButton="false"></fieldset>
    <row>
      <panel>
        <input type="dropdown" token="bbEnvLabel" searchWhenChanged="true">
          <label>Select Environment (by Label)</label>
          <default>impl</default>
          <choice value="impl">Sandbox env=impl</choice>
          <choice value="prod">Prod env=prod</choice>
          <choice value="*">ALL env=*</choice>
          <initialValue>prod</initialValue>
        </input>
      </panel>
      <panel>
        <input type="dropdown" token="bbEnv" searchWhenChanged="true">
          <label>Select Environment (by IP Range)</label>
          <default>ALL</default>
          <choice value="*">ALL</choice>
          <choice value="ip-10-246-44-*">Sandbox</choice>
          <choice value="ip-10-244-140-*">Prod</choice>
          <initialValue>ALL</initialValue>
        </input>
      </panel>
      <panel>
        <input type="time" token="t_local" searchWhenChanged="true">
          <label>Select Time Range</label>
          <default>
            <earliest>-7d@d</earliest>
            <latest>now</latest>
          </default>
        </input>
      </panel>
      <panel>
        <input type="dropdown" searchWhenChanged="true">
          <label>Select Application Name</label>
          <default>ALL</default>
          <choice value="*">ALL</choice>
          <choice value="excludeInternalApps">ExcludeInternalApps</choice>
          <initialValue>ALL</initialValue>
          <fieldForLabel>AppName</fieldForLabel>
          <fieldForValue>name</fieldForValue>
          <search>
            <query>index=bluebutton source="/var/log/pyapps/perf_mon.log*" env=$bbEnvLabel$ host=$bbEnv$ |spath output=name path="message.app_name" | table name | dedup name | sort name</query>
            <earliest>$t_local.earliest$</earliest>
            <latest>$t_local.latest$</latest>
          </search>
          <change>
              <condition value="excludeInternalApps">
                  <set token="appNameExpr">message.app_name!=&quot;TestApp&quot; AND message.app_name!=&quot;new-relic&quot;</set>
              </condition>
              <condition>
                  <set token="appNameExpr">message.app_name=&quot;$value$&quot;</set>
              </condition>
           </change>
        </input>
      </panel>
    </row>
    <row>
      <panel>
        <html>
         <u1> <h1>
              <b>Synthetic Data Accesses Stats</b>
            </h1>
          </u1>
       </html>
      </panel>
    </row>

    <search id="baseSearchFhirSynthetic">
       <query>index=bluebutton source="/var/log/pyapps/perf_mon.log*" host=$bbEnv$ env=$bbEnvLabel$ $appNameExpr$ | spath output=fhir_id path="message.fhir_id" | regex fhir_id="-\d+" | spath output=call_path path="message.path" | regex call_path="/v[12]/fhir/.*" | fields time message.path message.response_code message.fhir_id</query>
       <earliest>$t_local.earliest$</earliest>
       <latest>$t_local.latest$</latest>
       <sampleRatio>1</sampleRatio>
    </search>
  
    <row>
      <panel>
        <html>
         <u1> <h1>
              <b>Synthetic FHIR Requests</b>
            </h1>
          </u1>
       </html>
      </panel>
    </row>
    <row>
      <panel>
        <title>1. Synthetic Patient Requests (w/ successful status)</title>
        <single>
          <search>
            <done>
              <set token="tokSynthPatOKCount">$result.count$</set>
            </done>
            <query>index=bluebutton source="/var/log/pyapps/perf_mon.log*" host=$bbEnv$ env=$bbEnvLabel$ $appNameExpr$ | spath output=fhir_id path="message.fhir_id" | regex fhir_id="-\d+" | spath output=call_path path="message.path" | regex call_path="/v[12]/fhir/Patient.*" | search message.response_code=200 | stats count</query>
            <earliest>$t_local.earliest$</earliest>
            <latest>$t_local.latest$</latest>
            <sampleRatio>1</sampleRatio>
          </search>
          <option name="drilldown">all</option>
          <option name="height">226</option>
          <option name="refresh.display">progressbar</option>
        </single>
      </panel>
      <panel>
        <title>2. Synthetic Coverage Requests (w/ successful status)</title>
        <single>
          <search>
            <done>
              <set token="tokSynthCoverageOKCount">$result.count$</set>
            </done>
            <query>index=bluebutton source="/var/log/pyapps/perf_mon.log*" host=$bbEnv$ env=$bbEnvLabel$ $appNameExpr$ | spath output=fhir_id path="message.fhir_id" | regex fhir_id="-\d+" | spath output=call_path path="message.path" | regex call_path="/v[12]/fhir/Coverage.*" | search message.response_code=200 | stats count</query>
            <earliest>$t_local.earliest$</earliest>
            <latest>$t_local.latest$</latest>
            <sampleRatio>1</sampleRatio>
          </search>
          <option name="drilldown">all</option>
          <option name="height">226</option>
          <option name="refresh.display">progressbar</option>
        </single>
      </panel>
      <panel>
        <title>3. Synthetic EOB Requests (w/ successful status)</title>
        <single>
          <search>
            <done>
              <set token="tokSynthEobOKCount">$result.count$</set>
            </done>
            <query>index=bluebutton source="/var/log/pyapps/perf_mon.log*" host=$bbEnv$ env=$bbEnvLabel$ $appNameExpr$ | spath output=fhir_id path="message.fhir_id" | regex fhir_id="-\d+" | spath output=call_path path="message.path" | regex call_path="/v[12]/fhir/ExplanationOfBenefit.*" | search message.response_code=200 | stats count</query>
            <earliest>$t_local.earliest$</earliest>
            <latest>$t_local.latest$</latest>
            <sampleRatio>1</sampleRatio>
          </search>
          <option name="drilldown">all</option>
          <option name="height">226</option>
          <option name="refresh.display">progressbar</option>
        </single>
      </panel>
      <panel>
        <title>4. TOTAL Synthetic FHIR Requests (w/ successful status, might include fhir requests other than Patient, EOB, Coverage, e.g. metadata)</title>
        <single>
          <search base="baseSearchFhirSynthetic">
            <done>
              <set token="tokSynthFHIROKCount">$result.count$</set>
            </done>
            <query>search message.response_code=200 | stats count</query>
          </search>
          <option name="drilldown">all</option>
          <option name="height">226</option>
          <option name="refresh.display">progressbar</option>
        </single>
      </panel>
    </row>
  
    <row>
      <panel>
        <title>Active Apps (Accessed Syntheitc Data)</title>
        <single>
          <search base="baseSearchFhirSynthetic">
            <query>| spath output=client_id path="message.app_id" | where client_id != "" | stats distinct_count(client_id) as cid_total</query>
          </search>
          <option name="height">137</option>
          <option name="refresh.display">progressbar</option>
        </single>
      </panel>
      <panel>
        <title>Synthetic FHIR Requests By App</title>
        <table>
          <search base="baseSearchFhirSynthetic">
            <query>| spath output=client_id path="message.app_id" | spath output=name path="message.app_name" | spath output=user path="message.dev_name" | where client_id != "" | stats count by client_id, name, user | sort - count</query>
          </search>
          <option name="count">10</option>
          <option name="dataOverlayMode">none</option>
          <option name="drilldown">none</option>
          <option name="percentagesRow">false</option>
          <option name="refresh.display">progressbar</option>
          <option name="rowNumbers">false</option>
          <option name="totalsRow">false</option>
          <option name="wrap">true</option>
        </table>
      </panel>
    </row>

    <row>
      <panel>
        <chart>
          <title>Total Synthetic FHIR Requests OK (200) TIME-CHART</title>
          <search>
            <query>index=bluebutton source="/var/log/pyapps/perf_mon.log*" host=$bbEnv$ env=$bbEnvLabel$ $appNameExpr$ | spath output=fhir_id path="message.fhir_id" | regex fhir_id="-\d+" | spath output=call_path path="message.path" | regex call_path="/v[12]/fhir/.*" | timechart count</query>
            <earliest>$t_local.earliest$</earliest>
            <latest>$t_local.latest$</latest>
            <sampleRatio>1</sampleRatio>
          </search>
          <option name="charting.chart">column</option>
          <option name="charting.drilldown">none</option>
          <option name="height">199</option>
          <option name="refresh.display">progressbar</option>
        </chart>
      </panel>
    </row>
    <row>
      <panel>
        <chart>
          <title>Total FHIR Requests TIME-CHART</title>
          <search>
            <query>index=bluebutton source="/var/log/pyapps/perf_mon.log*" host=$bbEnv$ env=$bbEnvLabel$ $appNameExpr$ | spath output=call_path path="message.path" | regex call_path="/v[12]/fhir/.*" | timechart count</query>
            <earliest>$t_local.earliest$</earliest>
            <latest>$t_local.latest$</latest>
            <sampleRatio>1</sampleRatio>
          </search>
          <option name="charting.chart">column</option>
          <option name="charting.drilldown">none</option>
          <option name="height">199</option>
          <option name="refresh.display">progressbar</option>
        </chart>
      </panel>
    </row>
</form>
